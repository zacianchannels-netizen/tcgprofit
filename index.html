<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TCG Profit</title>

<style>
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
  background:#0f1115;
  color:#fff;
}
.container{
  padding:16px;
  padding-bottom:120px;
}
h2{ margin: 6px 0 14px; }
.card{
  background:#1a1d24;
  padding:14px;
  border-radius:12px;
  margin-bottom:12px;
}
input, select{
  width:100%;
  padding:10px;
  margin:6px 0;
  border-radius:8px;
  border:none;
  background:#2a2f38;
  color:#fff;
}
button{
  width:100%;
  padding:12px;
  margin-top:8px;
  border:none;
  border-radius:10px;
  font-size:16px;
  cursor:pointer;
}
.calc{ background:#3b82f6; color:#fff; }
.save{ background:#22c55e; color:#fff; }
.danger{ background:#ef4444; color:#fff; }
.result{
  text-align:center;
  font-size:26px;
  font-weight:800;
  margin-top:10px;
}
.small{
  opacity:.85;
  font-size:12px;
  line-height:1.4;
}
.row{
  display:flex;
  gap:8px;
}
.row > *{ flex:1; }
.tabs{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  background:#15181e;
  display:flex;
  border-top:1px solid rgba(255,255,255,.06);
}
.tab{
  flex:1;
  text-align:center;
  padding:14px 8px;
  cursor:pointer;
  user-select:none;
}
.tab.active{
  background:#1a1d24;
}
.hidden{ display:none; }
.preview{
  width:100%;
  margin-top:8px;
  border-radius:10px;
}
.grid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:6px;
}
.grid img{
  width:100%;
  border-radius:8px;
}
.pillbar{
  display:flex;
  gap:8px;
}
.pill{
  flex:1;
  background:#2a2f38;
  padding:10px;
  border-radius:10px;
  text-align:center;
  font-weight:700;
  cursor:pointer;
}
.pill.active{
  outline:2px solid rgba(34,197,94,.7);
}
.pill.orange.active{
  outline:2px solid rgba(59,130,246,.7);
}
.line{
  height:1px;
  background:rgba(255,255,255,.08);
  margin:10px 0;
}
.chips{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-top:10px;
}
.chip{
  background:#2a2f38;
  padding:8px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:800;
  cursor:pointer;
  user-select:none;
}
.chip.active{
  outline:2px solid rgba(34,197,94,.7);
}
.chip.blue.active{
  outline:2px solid rgba(59,130,246,.7);
}
.chip.red.active{
  outline:2px solid rgba(239,68,68,.75);
}

/* flip list: thumbnail on the left */
.flip-row{
  display:flex;
  gap:12px;
  align-items:flex-start;
}
.thumb{
  width:84px;
  height:84px;
  border-radius:10px;
  object-fit:cover;
  flex:0 0 84px;
  background:#2a2f38;
}

/* summary */
.summary-wrap{
  display:flex;
  gap:10px;
}
.summary-box{
  flex:1;
  background:#2a2f38;
  border-radius:12px;
  padding:12px;
}
.summary-label{
  font-size:11px;
  opacity:.85;
  font-weight:800;
}
.summary-value{
  margin-top:6px;
  font-size:18px;
  font-weight:900;
}
</style>
</head>

<body>

<!-- HOME -->
<div id="home" class="container">
  <h2>ğŸ’° åˆ©ç›Šè¨ˆç®—</h2>

  <div class="card">
    <input id="cardName" placeholder="ã‚«ãƒ¼ãƒ‰å">
    <input type="file" accept="image/*" onchange="previewCardImage(event)">
    <img id="cardImagePreview" class="preview hidden">

    <div class="row">
      <input id="shopName" placeholder="è³¼å…¥ã‚·ãƒ§ãƒƒãƒ—å">
      <input id="sellShopName" placeholder="å£²å´æ¸ˆã¿åº—èˆ—ï¼ˆãƒ•ãƒªãƒ/åº—åï¼‰">
    </div>

    <div class="row">
      <div style="flex:1;">
        <div class="small" style="margin-bottom:4px;">ï¼ˆè²·ã£ãŸæ—¥ä»˜ï¼‰</div>
        <div class="row">
          <input id="buyDate" type="date" onfocus="autofillYear(this)">
          <button type="button" onclick="setToday('buyDate')" style="width:80px;background:#3b82f6;">ä»Šæ—¥</button>
        </div>
      </div>
      <div style="flex:1;">
        <div class="small" style="margin-bottom:4px;">ï¼ˆå£²ã£ãŸæ—¥ä»˜ï¼‰</div>
        <div class="row">
          <input id="sellDate" type="date" onfocus="autofillYear(this)">
          <button type="button" onclick="setToday('sellDate')" style="width:80px;background:#3b82f6;">ä»Šæ—¥</button>
        </div>
      </div>
    </div>

    <div class="row">
      <div style="flex:1;">
        <div class="small" style="margin-bottom:4px;">ï¼ˆæšæ•°ï¼‰</div>
        <input id="quantity" type="number" placeholder="ã‚«ãƒ¼ãƒ‰æšæ•°" value="1">
      </div>
      <div style="flex:1;">
        <div class="small" style="margin-bottom:4px;">ï¼ˆä»•å…¥ã‚Œ/1æšï¼‰</div>
        <input id="purchase" type="number" placeholder="ä»•å…¥ã‚Œä¾¡æ ¼ï¼ˆ1æšï¼‰">
      </div>
    </div>

    <div class="card" style="background:#15181e;">
      <div class="small" style="font-weight:800; opacity:.95;">é‘‘å®šè²»ãƒ—ãƒ©ãƒ³ï¼ˆ1æšã‚ãŸã‚Šï¼‰</div>
      <select id="psaPlan" onchange="applyPsaPlan()">
        <option value="custom" selected>æ‰‹å…¥åŠ›</option>
        <option value="value_bulk">Â¥3,980</option>
        <option value="value">Â¥4,980</option>
        <option value="value_plus">Â¥7,980</option>
        <option value="value_max">Â¥8,980</option>
        <option value="regular">Â¥11,980</option>
        <option value="express">Â¥22,980</option>
        <option value="superexpress">Â¥44,980</option>
        <option value="walkthrough">Â¥89,980</option>
        <option value="premium1">Â¥149,980</option>
        <option value="premium2">Â¥299,980</option>
        <option value="premium3">Â¥449,980</option>
        <option value="premium5">Â¥749,980</option>
        <option value="premium10">Â¥1,499,980</option>
      </select>
      <div class="row">
        <input id="psaFee" type="number" placeholder="é‘‘å®šè²»ï¼ˆ1æšï¼‰">
        <input id="shipping" type="number" placeholder="é€æ–™ãƒ»é›‘è²»ï¼ˆåˆè¨ˆï¼‰">
      </div>
      <div class="small">â€»ãƒ—ãƒ©ãƒ³ã‚’é¸ã¶ã¨é‘‘å®šè²»ã«è‡ªå‹•åæ˜ ï¼ˆã‚ã¨ã§å¥½ãã«ä¸Šæ›¸ãOKï¼‰</div>
    </div>

    <div class="row">
      <input id="sellPrice" type="number" placeholder="å£²ã£ãŸé‡‘é¡ï¼ˆ1æšï¼‰">
      <input id="psa10" type="number" placeholder="PSA10ä¾¡æ ¼ï¼ˆæœªå£²å´æ™‚ã®å‚è€ƒï¼‰">
    <textarea id="memo" rows="3" placeholder="è©³ç´°ç­‰" style="width:100%;padding:10px;margin:6px 0;border-radius:8px;border:none;background:#2a2f38;color:#fff;"></textarea>

    </div>

    <button class="calc" onclick="calculate()">è¨ˆç®—</button>
    <button class="save" onclick="saveFlip()">è¨ˆç®—çµæœã‚’ä¿å­˜ï¼ˆä¿å­˜å¾Œã‚¯ãƒªã‚¢ï¼‰</button>

    <div id="result" class="result"></div>
    <div class="small">â€»å£²ã£ãŸé‡‘é¡ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã‚Œã°å®Ÿåˆ©ç›Šã€æœªå…¥åŠ›ãªã‚‰PSA10ä¾¡æ ¼ã‚’è¦‹è¾¼ã¿å£²ä¸Šã«ã—ã¦è¨ˆç®—ã—ã¾ã™ã€‚</div>
  </div>
</div>

<!-- FLIPS -->
<div id="flips" class="container hidden">
  <h2>ğŸ“Š å£²ä¸Šç®¡ç†</h2>

  <!-- NEW: summary (for filtered list) -->
  <div class="card" id="summaryCard">
    <div class="summary-wrap">
      <div class="summary-box">
        <div class="summary-label">è¡¨ç¤ºä¸­ã®ä»¶æ•°</div>
        <div class="summary-value" id="sumCount">0 ä»¶</div>
      </div>
      <div class="summary-box">
        <div class="summary-label">åˆè¨ˆåˆ©ç›Šï¼ˆè¡¨ç¤ºä¸­ï¼‰</div>
        <div class="summary-value" id="sumProfit">0 å††</div>
      </div>
    </div>
    <div class="summary-wrap" style="margin-top:10px;">
      <div class="summary-box">
        <div class="summary-label">å£²ä¸Šåˆè¨ˆï¼ˆè¡¨ç¤ºä¸­ï¼‰</div>
        <div class="summary-value" id="sumRevenue">0 å††</div>
      </div>
      <div class="summary-box">
        <div class="summary-label">ä»•å…¥ã‚Œåˆè¨ˆï¼ˆè¡¨ç¤ºä¸­ï¼‰</div>
        <div class="summary-value" id="sumPurchase">0 å††</div>
      </div>
    </div>

    <div class="line"></div>
    <div class="small">â€»ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆå£²ã‚ŒãŸ/æœªå£²å´ãƒ»åˆ©ç›Šï¼‹/âˆ’ãƒ»æ¤œç´¢ï¼‰ã§çµã£ãŸ â€œè¡¨ç¤ºä¸­â€ ã®åˆè¨ˆã§ã™ã€‚</div>
    <div class="line"></div>
    <div class="small" style="font-weight:900; opacity:.95;">æœˆã”ã¨ã®åˆ©ç›Šï¼ˆå£²å´æ—¥ãƒ™ãƒ¼ã‚¹ï¼‰</div>
    <div class="small">â€»å£²å´æ—¥ãŒå…¥ã£ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ã ã‘é›†è¨ˆã—ã¾ã™ã€‚</div>
    <div id="monthlyList" class="small" style="margin-top:8px;"></div>
  </div>

  <div class="card">
    <input id="searchName" placeholder="æ¤œç´¢ï¼ˆã‚«ãƒ¼ãƒ‰åï¼‰" oninput="loadFlips()">

    <div class="row">
      <select id="monthFilterMode" onchange="loadFlips()">
        <option value="sell" selected>å£²å´æœˆã§çµã‚‹</option>
        <option value="buy">è³¼å…¥æœˆã§çµã‚‹</option>
      </select>
      <input id="monthFilter" type="month" onchange="loadFlips()">
    </div>
    <div class="small">â€»ã€Œ2026-02ã€ã¿ãŸã„ã«æœˆã§çµã‚Šè¾¼ã¿ã€‚ç©ºãªã‚‰å…¨æœŸé–“ã€‚</div>


    <div class="pillbar">
      <div id="sortSell" class="pill active" onclick="setSortMode('sell')">å£²å´æ—¥é †</div>
      <div id="sortBuy" class="pill orange" onclick="setSortMode('buy')">è³¼å…¥æ—¥é †</div>
    </div>

    <div class="chips">
      <div id="filterAll" class="chip active" onclick="setStatusFilter('all')">å…¨ã¦</div>
      <div id="filterSold" class="chip blue" onclick="setStatusFilter('sold')">å£²ã‚ŒãŸ</div>
      <div id="filterUnsold" class="chip" onclick="setStatusFilter('unsold')">æœªå£²å´</div>
      <div id="filterProfitPlus" class="chip" onclick="setProfitFilter('plus')">åˆ©ç›Šï¼‹</div>
      <div id="filterProfitMinus" class="chip red" onclick="setProfitFilter('minus')">åˆ©ç›Šâˆ’</div>
    </div>

    <div class="line"></div>
    <div class="small">
      ãƒ»ã€Œå£²ã‚ŒãŸã€= å£²å´æ—¥ã‚ã‚Š / ã€Œæœªå£²å´ã€= å£²å´æ—¥ãªã—<br>
      ãƒ»åˆ©ç›Šï¼‹/âˆ’ ã¯ä¿å­˜ã—ãŸåˆ©ç›Šã‚’åŸºæº–ã«çµã‚Šè¾¼ã¿<br>
      ãƒ»æ¤œç´¢ã¯ã‚«ãƒ¼ãƒ‰åã§çµã‚Šè¾¼ã¿ï¼ˆå£²ä¸Šç®¡ç†ï¼‰<br>
      ãƒ»æœˆãƒ•ã‚£ãƒ«ã‚¿ã§ã€Œå£²å´æœˆ / è³¼å…¥æœˆã€ã‚’çµã‚Šè¾¼ã¿
    </div>
    <button class="danger" onclick="clearFlips()">ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å…¨å‰Šé™¤</button>
  </div>

  <div id="flipList"></div>
</div>

<!-- RECEIPTS -->
<div id="receipts" class="container hidden">
  <h2>ğŸ§¾ ãƒ¬ã‚·ãƒ¼ãƒˆã‚¢ãƒ«ãƒãƒ </h2>

  <div class="card">
    <input id="albumName" placeholder="ã‚¢ãƒ«ãƒãƒ åï¼ˆä¾‹ï¼š10æœˆä»•å…¥ã‚Œãƒ¬ã‚·ãƒ¼ãƒˆã€8æœˆå£²å´ãƒ¬ã‚·ãƒ¼ãƒˆï¼‰">
    <button class="save" onclick="createAlbum()">ã‚¢ãƒ«ãƒãƒ ä½œæˆ</button>
    <div class="small">â€»ç”»åƒã¯ç«¯æœ«å†…ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ç”»åƒãŒå¤šã„ã¨é‡ããªã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚</div>
  </div>

  <div id="albumList"></div>
</div>

<!-- SETTINGS -->
<div id="settings" class="container hidden">
  <h2>âš™ï¸ è¨­å®š</h2>
  <div class="card">è¨­å®šã¯ä»Šå¾Œè¿½åŠ äºˆå®š</div>
</div>

<div class="tabs">
  <div id="tab-home" class="tab active" onclick="showTab('home')">ğŸ </div>
  <div id="tab-flips" class="tab" onclick="showTab('flips')">ğŸ“Š</div>
  <div id="tab-receipts" class="tab" onclick="showTab('receipts')">ğŸ§¾</div>
  <div id="tab-settings" class="tab" onclick="showTab('settings')">âš™ï¸</div>
</div>

<script>
/* ===== Shared state ===== */
let lastProfit = 0;
let lastRevenuePerCard = 0;
let lastTotalRevenue = 0;
let lastTotalCost = 0;
let lastCardImage = "";
let sortMode = "sell";         // 'sell' or 'buy'
let statusFilter = "all";      // 'all' | 'sold' | 'unsold'
let profitFilter = "any";      // 'any' | 'plus' | 'minus'
// PSA plan presets (Â¥ per card) - based on your provided latest PSA pricing
const PSA_PLAN_FEES = {
  custom: null,
  value_bulk: 3980,
  value: 4980,
  value_plus: 7980,
  value_max: 8980,
  regular: 11980,
  express: 22980,
  superexpress: 44980,
  walkthrough: 89980,
  premium1: 149980,
  premium2: 299980,
  premium3: 449980,
  premium5: 749980,
  premium10: 1499980
};

function applyPsaPlan(){
  const planEl = document.getElementById("psaPlan");
  const feeEl = document.getElementById("psaFee");
  if(!planEl || !feeEl) return;

  const plan = planEl.value;
  const fee = PSA_PLAN_FEES[plan];
  if(fee !== null && fee !== undefined){
    feeEl.value = String(fee);
  }
}


function fmtYen(n){
  const x = Number(n) || 0;
  return x.toLocaleString("ja-JP") + " å††";
}
function safeDateVal(v){
  return (v && typeof v === "string") ? v : "";
}
function dateKey(d){
  if(!d) return "0000-00-00";
  return d;
}

/* ===== Auto-fill year for date inputs ===== */
function setToday(id){
  const now = new Date();
  const yyyy = now.getFullYear();
  const mm = String(now.getMonth()+1).padStart(2,"0");
  const dd = String(now.getDate()).padStart(2,"0");
  document.getElementById(id).value = `${yyyy}-${mm}-${dd}`;
}

function autofillYear(el){
  if(!el.value){
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth()+1).padStart(2,"0");
    const dd = String(now.getDate()).padStart(2,"0");
    el.value = `${yyyy}-${mm}-${dd}`;
  }
}

/* ===== Image preview ===== */
function previewCardImage(event){
  const file = event.target.files && event.target.files[0];
  if(!file) return;

  const reader = new FileReader();
  reader.onload = function(e){
    const img = document.getElementById("cardImagePreview");
    img.src = e.target.result;
    img.classList.remove("hidden");
    lastCardImage = e.target.result;
  };
  reader.readAsDataURL(file);
}

/* ===== Profit calculation ===== */
function calculate(){
  const quantity = Number(document.getElementById("quantity").value) || 1;
  const purchase = Number(document.getElementById("purchase").value) || 0; // per card
  const psaFee  = Number(document.getElementById("psaFee").value) || 0;    // per card
  const shipping = Number(document.getElementById("shipping").value) || 0; // total
  const sellPrice = Number(document.getElementById("sellPrice").value) || 0; // per card
  const psa10 = Number(document.getElementById("psa10").value) || 0;
  const memo = document.getElementById("memo").value || ""; // per card reference

  const revenuePerCard = sellPrice > 0 ? sellPrice : psa10;
  const totalRevenue = revenuePerCard * quantity;
  const totalCost = (purchase + psaFee) * quantity + shipping;
  const profit = Math.round(totalRevenue - totalCost);

  lastProfit = profit;
  lastRevenuePerCard = revenuePerCard;
  lastTotalRevenue = totalRevenue;
  lastTotalCost = totalCost;

  const result = document.getElementById("result");
  result.innerHTML = fmtYen(profit);
  result.style.color = profit >= 0 ? "#22c55e" : "#ef4444";
}

/* ===== Flips save/list ===== */
function getFlips(){ return JSON.parse(localStorage.getItem("flips") || "[]"); }
function setFlips(arr){ localStorage.setItem("flips", JSON.stringify(arr)); }

function clearHomeInputs(){
  const ids = [
    "cardName","shopName","sellShopName","buyDate","sellDate","quantity","purchase",
    "psaFee","shipping","sellPrice","psa10","memo"
  ];
  ids.forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    if(id === "quantity") el.value = "1";
    else el.value = "";
  });

  const planEl = document.getElementById('psaPlan');
  if(planEl) planEl.value = 'custom';

  const fileInputs = document.querySelectorAll("#home input[type='file']");
  fileInputs.forEach(fi=> fi.value = "");

  const img = document.getElementById("cardImagePreview");
  img.src = "";
  img.classList.add("hidden");
  lastCardImage = "";

  const result = document.getElementById("result");
  result.innerHTML = "";
}

function saveFlip(){
  calculate();

  const name = document.getElementById("cardName").value || "åç§°æœªè¨­å®š";
  const shop = document.getElementById("shopName").value || "ä¸æ˜";
  const sellShopName = document.getElementById("sellShopName").value || "";
  const buyDate = safeDateVal(document.getElementById("buyDate").value);
  const sellDate = safeDateVal(document.getElementById("sellDate").value);

  const quantity = Number(document.getElementById("quantity").value) || 1;
  const purchase = Number(document.getElementById("purchase").value) || 0;
  const psaFee  = Number(document.getElementById("psaFee").value) || 0;
  const shipping = Number(document.getElementById("shipping").value) || 0;

  const sellPrice = Number(document.getElementById("sellPrice").value) || 0;
  const psa10 = Number(document.getElementById("psa10").value) || 0;
  const memo = document.getElementById("memo").value || "";

  const flips = getFlips();
  flips.push({
    id: Date.now(),
    name, shop, sellShopName,
    image: lastCardImage,
    buyDate, sellDate,
    quantity,
    purchase, psaFee, shipping,
    sellPrice,
    psa10,
    memo,
    revenuePerCard: lastRevenuePerCard,
    totalRevenue: lastTotalRevenue,
    totalCost: lastTotalCost,
    profit: lastProfit
  });
  setFlips(flips);

  alert("ä¿å­˜ã—ã¾ã—ãŸï¼ˆå…¥åŠ›ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸï¼‰");
  clearHomeInputs();
}

/* ===== Sorting + Filtering UI ===== */
function setSortMode(mode){
  sortMode = mode;
  document.getElementById("sortSell").classList.toggle("active", mode === "sell");
  document.getElementById("sortBuy").classList.toggle("active", mode === "buy");
  loadFlips();
}

function setStatusFilter(mode){
  statusFilter = mode;
  document.getElementById("filterAll").classList.toggle("active", mode === "all");
  document.getElementById("filterSold").classList.toggle("active", mode === "sold");
  document.getElementById("filterUnsold").classList.toggle("active", mode === "unsold");
  loadFlips();
}

function setProfitFilter(mode){
  if(profitFilter === mode){
    profitFilter = "any";
  }else{
    profitFilter = mode;
  }
  document.getElementById("filterProfitPlus").classList.toggle("active", profitFilter === "plus");
  document.getElementById("filterProfitMinus").classList.toggle("active", profitFilter === "minus");
  loadFlips();
}

function applyFilters(flips){
  const q = (document.getElementById("searchName").value || "").trim().toLowerCase();
  const monthVal = (document.getElementById("monthFilter").value || "").trim(); // YYYY-MM
  const monthMode = (document.getElementById("monthFilterMode").value || "sell");

  return flips.filter(f=>{
    const sold = !!(f.sellDate && String(f.sellDate).trim());
    // æœˆãƒ•ã‚£ãƒ«ã‚¿ï¼ˆYYYY-MMï¼‰
    if(monthVal){
      const targetDate = (monthMode === "buy") ? (f.buyDate || "") : (f.sellDate || "");
      // å£²å´æœˆãƒ•ã‚£ãƒ«ã‚¿ã§æœªå£²å´ã‚’é™¤å¤–ã—ãŸã„å ´åˆã¯ targetDateãŒç©ºã§å¼¾ã‹ã‚Œã‚‹
      if(!targetDate || String(targetDate).slice(0,7) !== monthVal) return false;
    }

    if(statusFilter === "sold" && !sold) return false;
    if(statusFilter === "unsold" && sold) return false;

    const p = Number(f.profit) || 0;
    if(profitFilter === "plus" && p < 0) return false;
    if(profitFilter === "minus" && p >= 0) return false;

    if(q){
      const name = String(f.name || "").toLowerCase();
      if(!name.includes(q)) return false;
    }
    return true;
  });
}

function updateSummary(flips){
  const count = flips.length;
  const totalProfit = flips.reduce((acc,f)=> acc + (Number(f.profit)||0), 0);
  const totalRevenue = flips.reduce((acc,f)=> acc + (Number(f.totalRevenue)||0), 0);
  const totalPurchase = flips.reduce((acc,f)=> acc + ((Number(f.purchase)||0) * (Number(f.quantity)||0)), 0);

  document.getElementById("sumCount").textContent = count.toLocaleString("ja-JP") + " ä»¶";
  const profitEl = document.getElementById("sumProfit");
  profitEl.textContent = fmtYen(Math.round(totalProfit));
  profitEl.style.color = totalProfit >= 0 ? "#22c55e" : "#ef4444";
  const revEl = document.getElementById("sumRevenue");
  if(revEl){ revEl.textContent = fmtYen(Math.round(totalRevenue)); revEl.style.color = "#fff"; }
  const purEl = document.getElementById("sumPurchase");
  if(purEl){ purEl.textContent = fmtYen(Math.round(totalPurchase)); purEl.style.color = "#fff"; }
}

function renderMonthlyProfit(flips){
  // sold items only, use sellDate's YYYY-MM
  const sold = flips.filter(f => f.sellDate && String(f.sellDate).trim());
  const map = new Map(); // key: YYYY-MM, value: profit sum
  sold.forEach(f=>{
    const d = String(f.sellDate);
    const key = d.slice(0,7); // YYYY-MM
    const p = Number(f.profit) || 0;
    map.set(key, (map.get(key) || 0) + p);
  });

  // sort by month desc
  const items = Array.from(map.entries()).sort((a,b)=> b[0].localeCompare(a[0]));

  const el = document.getElementById("monthlyList");
  if(!el) return;

  if(items.length === 0){
    el.innerHTML = "å£²å´æ—¥ãŒå…¥ã£ã¦ã„ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚";
    return;
  }

  el.innerHTML = items.map(([ym, sum])=>{
    const label = ym.replace("-", "å¹´") + "æœˆ";
    const val = fmtYen(Math.round(sum));
    const color = sum >= 0 ? "#22c55e" : "#ef4444";
    return `<div style="display:flex;justify-content:space-between;gap:12px;padding:6px 0;border-bottom:1px solid rgba(255,255,255,.06);">
      <div>${label}</div>
      <div style="font-weight:900;color:${color};">${val}</div>
    </div>`;
  }).join("");
}


function loadFlips(){
  const container = document.getElementById("flipList");
  container.innerHTML = "";

  let flips = getFlips();
  flips = applyFilters(flips);

  // update summary before sorting (same list)
  updateSummary(flips);
  renderMonthlyProfit(flips);

  if(sortMode === "sell"){
    flips.sort((a,b)=>{
      const aSold = !!a.sellDate;
      const bSold = !!b.sellDate;
      if(aSold !== bSold) return aSold ? -1 : 1;
      if(aSold && bSold){
        return dateKey(b.sellDate).localeCompare(dateKey(a.sellDate));
      }
      return dateKey(b.buyDate).localeCompare(dateKey(a.buyDate));
    });
  }else{
    flips.sort((a,b)=> dateKey(b.buyDate).localeCompare(dateKey(a.buyDate)));
  }

  if(flips.length === 0){
    const empty = document.createElement("div");
    empty.className = "card";
    empty.innerHTML = "æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br><span class='small'>ãƒ•ã‚£ãƒ«ã‚¿ã‚’ã€Œå…¨ã¦ã€ã«æˆ»ã™ã‹ã€æ¤œç´¢ã‚’æ¶ˆã—ã¦ã€åˆ©ç›Šè¨ˆç®—ã§ä¿å­˜ã—ã¦ãã ã•ã„ã€‚</span>";
    container.appendChild(empty);
    return;
  }

  flips.forEach(f=>{
    const div = document.createElement("div");
    div.className = "card";
    const profitColor = (Number(f.profit)||0) >= 0 ? "#22c55e" : "#ef4444";

    div.innerHTML = `
      <div class="flip-row">
        ${f.image ? `<img src="${f.image}" class="thumb">` : `<div class="thumb"></div>`}
        <div style="flex:1;">
          <div style="font-weight:900; font-size:16px;">${f.name}</div>
          <div class="small">è³¼å…¥ï¼š${f.shop}ã€€${f.buyDate || "-"}</div>
          <div class="small">å£²å´ï¼š${f.sellShopName ? f.sellShopName : "-"}ã€€${f.sellDate || "-"}</div>
          <div class="small">ãƒ¡ãƒ¢ï¼š${f.memo ? f.memo.replace(/\n/g,"<br>") : "-"}<br>æšæ•°ï¼š${f.quantity}ã€€ä»•å…¥ã‚Œ(1æš)ï¼š${fmtYen(f.purchase)}ã€€å£²å€¤(1æš)ï¼š${f.sellPrice ? fmtYen(f.sellPrice) : "-"}</div>
        </div>
      </div>

      <div class="line"></div>
      <div style="font-size:20px; font-weight:900; color:${profitColor}; text-align:center;">
        ${fmtYen(f.profit)}
      </div>
      <div class="small" style="text-align:center;">
        å£²ä¸Šåˆè¨ˆï¼š${fmtYen(f.totalRevenue)} ï¼ ã‚³ã‚¹ãƒˆåˆè¨ˆï¼š${fmtYen(f.totalCost)}
      </div>
    `;
    container.appendChild(div);
  });
}

function clearFlips(){
  if(confirm("æœ¬å½“ã«å…¨å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){
    localStorage.removeItem("flips");
    // reset summary too
    updateSummary([]);
    loadFlips();
  }
}

/* ===== Receipt albums ===== */
function createAlbum(){
  const name = document.getElementById("albumName").value;
  if(!name) return alert("ã‚¢ãƒ«ãƒãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");

  const albums = JSON.parse(localStorage.getItem("albums")||"[]");
  albums.push({name:name,images:[]});
  localStorage.setItem("albums",JSON.stringify(albums));
  document.getElementById("albumName").value="";
  loadAlbums();
}
function loadAlbums(){
  const container = document.getElementById("albumList");
  container.innerHTML="";
  const albums = JSON.parse(localStorage.getItem("albums")||"[]");

  albums.forEach((album,index)=>{
    const div=document.createElement("div");
    div.className="card";
    div.innerHTML = `
      <div style="font-weight:800; margin-bottom:8px;">${album.name}</div>
      <input type="file" multiple accept="image/*" onchange="addImages(event,${index})">
      <div class="grid"></div>
    `;
    container.appendChild(div);

    const grid = div.querySelector(".grid");
    album.images.forEach(img=>{
      const image=document.createElement("img");
      image.src=img;
      grid.appendChild(image);
    });
  });
}
function addImages(event,index){
  const files = event.target.files;
  const albums = JSON.parse(localStorage.getItem("albums")||"[]");

  Array.from(files).forEach(file=>{
    const reader = new FileReader();
    reader.onload = function(e){
      albums[index].images.push(e.target.result);
      localStorage.setItem("albums",JSON.stringify(albums));
      loadAlbums();
    };
    reader.readAsDataURL(file);
  });
}

/* ===== Tabs ===== */
function showTab(id){
  ["home","flips","receipts","settings"].forEach(t=>{
    document.getElementById(t).classList.add("hidden");
  });
  document.getElementById(id).classList.remove("hidden");

  ["home","flips","receipts","settings"].forEach(t=>{
    document.getElementById("tab-"+t).classList.remove("active");
  });
  document.getElementById("tab-"+id).classList.add("active");

  if(id==="flips") loadFlips();
  if(id==="receipts") loadAlbums();
}
showTab("home");
</script>

</body>
</html>
